<!DOCTYPE html>
<html>
<head>
  <base href="." />
  <meta charset="UTF-8">
  <title>Реалистичная сцена с автомобилем и человеком</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas {
      display: block;
    }
    
    .instructions {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      z-index: 1;
    }

    /* Спидометр */
    #speedometer {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 200px;
      height: 100px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      z-index: 1;
    }
  </style>
</head>
<body>
  <div class="instructions">
    WASD - движение<br>
    F - сесть/выйти из машины<br>
    Мышь - осмотреться
  </div>

  <!-- Канвас для спидометра -->
  <canvas id="speedometer" width="200" height="100"></canvas>
  
  <!-- Подключаем three.js и GLTFLoader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  
  <script>
    // Создаем сцену, камеру и рендерер
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xa0a0a0);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);
    
    // Добавляем освещение
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 20, 10);
    directionalLight.castShadow = true;
    directionalLight.shadow.camera.top = 20;
    directionalLight.shadow.camera.bottom = -20;
    directionalLight.shadow.camera.left = -20;
    directionalLight.shadow.camera.right = 20;
    scene.add(directionalLight);
    
    // Создаем землю
    const groundGeometry = new THREE.PlaneGeometry(500, 500);
    const groundMaterial = new THREE.MeshStandardMaterial({color: 0x228B22});
    const ground = new THREE.Mesh(groundGeometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);
    
    // Загрузка 3D модели автомобиля
    const loader = new THREE.GLTFLoader();
    let car;
    loader.load(
      'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/CesiumMilkTruck/glTF-Binary/CesiumMilkTruck.glb',
      function(gltf){
        car = gltf.scene;
        car.scale.set(0.5, 0.5, 0.5); // Настройка масштаба
        car.position.set(0, 0, 0);
        car.traverse(function(node){
          if(node.isMesh){
            node.castShadow = true;
            node.receiveShadow = true;
          }
        });
        scene.add(car);
      },
      undefined,
      function(error){
        console.error('Ошибка загрузки модели автомобиля:', error);
        // Если модель не загрузилась, используем простую геометрию
        const carGeometry = new THREE.BoxGeometry(2, 1, 4);
        const carMaterial = new THREE.MeshStandardMaterial({color: 0xff0000});
        car = new THREE.Mesh(carGeometry, carMaterial);
        car.position.y = 0.5;
        car.castShadow = true;
        car.receiveShadow = true;
        scene.add(car);
      }
    );
    
    // Загрузка 3D модели игрока
    let player;
    loader.load(
      'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Flamingo/glTF-Binary/Flamingo.glb',
      function(gltf){
        player = gltf.scene;
        player.scale.set(0.02, 0.02, 0.02); // Настройка масштаба
        player.position.set(5, 0, 0);
        player.traverse(function(node){
          if(node.isMesh){
            node.castShadow = true;
            node.receiveShadow = true;
          }
        });
        scene.add(player);
      },
      undefined,
      function(error){
        console.error('Ошибка загрузки модели игрока:', error);
        // Если модель не загрузилась, используем простую геометрию
        const playerGeometry = new THREE.BoxGeometry(0.5, 1.8, 0.5);
        const playerMaterial = new THREE.MeshStandardMaterial({color: 0x0000ff});
        player = new THREE.Mesh(playerGeometry, playerMaterial);
        player.position.set(5, 0.9, 0);
        player.castShadow = true;
        player.receiveShadow = true;
        scene.add(player);
      }
    );
    
    // Начальная позиция камеры
    camera.position.set(0, 5, 15);
    
    // Состояния игры
    let inCar = false;
    let moveForward = false;
    let moveBackward = false;
    let moveLeft = false;
    let moveRight = false;
    let rotation = 0;
    let speed = 0;
    
    // Обработчики клавиш
    document.addEventListener('keydown', (event) => {
      switch(event.code) {
        case 'KeyW': moveForward = true; break;
        case 'KeyS': moveBackward = true; break;
        case 'KeyA': moveLeft = true; break;
        case 'KeyD': moveRight = true; break;
        case 'KeyF':
          if(car && player && player.visible === true && player.position.distanceTo(car.position) < 5) {
            inCar = !inCar;
            if(inCar) {
              player.visible = false;
            } else {
              player.visible = true;
              player.position.set(
                car.position.x + 3 * Math.sin(rotation),
                0.5,
                car.position.z + 3 * Math.cos(rotation)
              );
            }
          }
          break;
      }
    });
    
    document.addEventListener('keyup', (event) => {
      switch(event.code) {
        case 'KeyW': moveForward = false; break;
        case 'KeyS': moveBackward = false; break;
        case 'KeyA': moveLeft = false; break;
        case 'KeyD': moveRight = false; break;
      }
    });
    
    // Управление мышью
    document.addEventListener('mousemove', (event) => {
      if (document.pointerLockElement === renderer.domElement) {
        rotation -= event.movementX * 0.002;
      }
    });
    
    // Блокировка указателя мыши
    renderer.domElement.addEventListener('click', () => {
      renderer.domElement.requestPointerLock();
    });
    
    // Настройка спидометра
    const speedometer = document.getElementById('speedometer');
    const ctx = speedometer.getContext('2d');
    
    function drawSpeedometer(currentSpeed) {
      ctx.clearRect(0, 0, speedometer.width, speedometer.height);
      
      // Рамка спидометра
      ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      ctx.fillRect(0, 0, speedometer.width, speedometer.height);
      
      // Текст скорости
      ctx.fillStyle = 'white';
      ctx.font = '20px Arial';
      ctx.fillText(`Скорость: ${Math.round(currentSpeed * 10)} км/ч`, 10, 30);
      
      // Простая шкала
      ctx.beginPath();
      ctx.moveTo(10, 50);
      ctx.lineTo(speedometer.width - 10, 50);
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Индикатор скорости
      const maxSpeed = 100;
      const speedRatio = Math.min(currentSpeed * 10 / maxSpeed, 1);
      const indicatorX = 10 + speedRatio * (speedometer.width - 20);
      ctx.beginPath();
      ctx.arc(indicatorX, 50, 5, 0, Math.PI * 2);
      ctx.fillStyle = 'red';
      ctx.fill();
    }
    
    // Функция анимации
    function animate() {
      requestAnimationFrame(animate);
    
      const accel = 0.2;
      const decel = 0.1;
      const rotSpeed = 0.02;
    
      if(car && inCar) {
        // Управление машиной
        if(moveForward) {
          speed += accel;
        }
        if(moveBackward) {
          speed -= accel;
        }
        if(!moveForward && !moveBackward) {
          // Естественное замедление
          if(speed > 0) {
            speed -= decel;
            speed = Math.max(speed, 0);
          } else {
            speed += decel;
            speed = Math.min(speed, 0);
          }
        }
        if(moveLeft) rotation += rotSpeed;
        if(moveRight) rotation -= rotSpeed;
    
        // Ограничение скорости
        speed = Math.max(-10, Math.min(speed, 10));
    
        // Обновление позиции машины
        car.rotation.y = rotation;
        car.position.x += Math.sin(rotation) * speed * 0.1;
        car.position.z += Math.cos(rotation) * speed * 0.1;
        
        // Камера следует за машиной
        camera.position.x = car.position.x - Math.sin(rotation) * 15;
        camera.position.z = car.position.z - Math.cos(rotation) * 15;
        camera.position.y = car.position.y + 10;
        camera.lookAt(car.position);
        
        drawSpeedometer(Math.abs(speed * 10));
      } else if(player) {
        // Управление игроком
        if(moveForward) {
          player.position.x += Math.sin(rotation) * 0.1;
          player.position.z += Math.cos(rotation) * 0.1;
        }
        if(moveBackward) {
          player.position.x -= Math.sin(rotation) * 0.1;
          player.position.z -= Math.cos(rotation) * 0.1;
        }
        if(moveLeft) rotation += rotSpeed;
        if(moveRight) rotation -= rotSpeed;
    
        player.rotation.y = rotation;
        
        // Камера следует за игроком
        camera.position.x = player.position.x - Math.sin(rotation) * 5;
        camera.position.z = player.position.z - Math.cos(rotation) * 5;
        camera.position.y = player.position.y + 5;
        camera.lookAt(player.position);
        
        drawSpeedometer(0); // Скорость равна 0, когда игрок не в машине
      }
    
      renderer.render(scene, camera);
    }
    
    animate();
    
    // Обработка изменения размера окна
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
